# apparmor.d - Full set of apparmor profiles
# Copyright (C) 2025 Alexandre Pujol <alexandre@pujol.io>
# SPDX-License-Identifier: GPL-2.0-only

# Allow confined users to read, write, lock and link to their own files
# anywhere, and execute from some places.

abi <abi/4.0>,

include <tunables/global>

profile role_root {
  include <abstractions/base>
  include <abstractions/consoles>
  include <abstractions/nameservice-strict>
  include <abstractions/shells>

  # set rlimit cpu <= , # TODO; see how everything can be limited here

  capability dac_override,
  capability dac_read_search,

  network netlink raw,

  # Allow to run everything, but wintin this role
  @{bin}/** mrix,
  @{lib}/** mrix,

  # Allow to run some specific program and to transition to their profile
  @{bin}/aa-log     rPx,
  @{bin}/aa-status  rPx,

  # Allow to update/show the Message of the Day
  @{bin}/landscape-sysinfo rPx,
  /etc/update-motd.d/* rPx,
  /usr/share/landscape/landscape-sysinfo.wrapper rPx,

  @{bin}/ r,
  @{lib}/ r,
  /usr/local/{,**} r,

  /usr/share/vim/** r,

  # To see the apparmor profiles in use
  /etc/apparmor/{,**} r,
  /etc/apparmor.d/{,**} r,

  # For htop, harmless to allow
  /etc/sensors.d/{,**} r,
  /etc/sensors3.conf r,

  /etc/vim/vimrc r,

  / r,
  /*/ r,

  owner /root/ r,
  owner /root/*/ rw,
  owner /root/*/** mrix,
  owner /root/*/** rwkl -> /root/*/**,
  owner /root/dont-delete-me-please.txt r,

  # See all processes, users, the kernel settings, the hardware, the network...
  @{sys}/{,**} r,
  @{PROC}/{,**} r,

  # A list of actions explicitly denied to the role in order to not fill the logs

  deny capability sys_ptrace,

  deny network inet dgram,
  deny network inet6 dgram,
  deny network inet raw,
  deny network inet6 raw,

  deny ptrace read,

  deny @{bin}/{kmod,lsmod,depmod,insmod,rmmod,modinfo,modprobe} x,

        deny owner /root/.config/htop/htoprc w,
  audit deny owner /root/.ssh/** w,
  audit deny owner /root/dont-delete-me-please.txt w,

  include if exists <local/role_root>
}

# vim:syntax=apparmor
