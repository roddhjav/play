# apparmor.d - Full set of apparmor profiles
# Copyright (C) 2025 Alexandre Pujol <alexandre@pujol.io>
# SPDX-License-Identifier: GPL-2.0-only

# Allow confined users to read, write, lock and link to their own files
# anywhere, and execute from some places.

abi <abi/4.0>,

include <tunables/global>

profile role_root {
  include <abstractions/base>
  include <abstractions/consoles>
  include <abstractions/nameservice-strict>
  include <abstractions/shells>

  deny capability sys_ptrace,

  deny network inet dgram,
  deny network inet6 dgram,
  deny network inet raw,
  deny network inet6 raw,

  # Allow to run everything, but in this role.
  @{bin}/** mrix,
  @{lib}/** mrix,

  # Allow to run some specific program and to transition to their profile
  @{bin}/aa-log rPx,
  @{bin}/aa-status rPx,

  /etc/apparmor/** r,
  /etc/apparmor.d/** r,

  owner /root/ r,
  owner /root/** mrix,
  owner /root/*/ rw,
  owner /root/*/** rwkl -> /root/*/**,
  owner /root/thanks-append-only.txt ra,

  deny owner /root/.ssh/authorized_keys w,

  @{PROC}/** r,

  deny @{bin}/{kmod,lsmod,depmod,insmod,rmmod,modinfo,modprobe} x,

  include if exists <local/role_root>
}

# vim:syntax=apparmor
