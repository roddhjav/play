# apparmor.d - Full set of apparmor profiles
# Copyright (C) 2025 Alexandre Pujol <alexandre@pujol.io>
# SPDX-License-Identifier: GPL-2.0-only

# Allow confined users to read, write, lock and link to their own files
# anywhere, and execute from some places.

# Don't confine members whose primary group is 'admin' who are not specifically
# confined. Systems without this special primary group may want to define an
# unconfined 'root' hat in this manner (depending on site policy).

abi <abi/4.0>,

include <tunables/global>

profile role_root {
  include <abstractions/base>
  include <abstractions/bus-system>
  include <abstractions/common/apt>
  include <abstractions/consoles>
  include <abstractions/nameservice-strict>
  include <abstractions/shells>

  set rlimit cpu <= 100,
  set rlimit fsize <= 5242880, # 5MB
  set rlimit nofile <= 256,

  capability dac_override,
  capability dac_read_search,

  network netlink raw,

  # Allow to run everything, but in the scope of this role only
  @{bin}/** mrix,
  @{lib}/** mrix,

  # Allow to run some specific program and to transition to their profile
  @{bin}/aa-enabled                               Px,
  @{bin}/aa-log                                   Px,
  @{bin}/aa-status                                Px,
  @{bin}/blkid                                    Px,
  @{bin}/df                                       Px,
  @{bin}/dmesg                                    Px,
  @{bin}/findmnt                                  Px,
  @{bin}/free                                     Px,
  @{bin}/htop                                     Px,
  @{bin}/lsblk                                    Px,
  @{bin}/lscpu                                    Px,
  @{bin}/lspci                                    Px,
  @{bin}/ps                                       Px,
  @{bin}/pstree                                   Px,
  @{bin}/top                                      Px,
  @{bin}/uname                                    Px,
  @{bin}/uptime                                   Px,
  @{bin}/users                                    Px,
  @{bin}/w                                        Px,
  @{bin}/who                                      Px,
  @{lib}/command-not-found                        Px,

  # To see the apparmor profiles in use
  /etc/apparmor/{,**} r,
  /etc/apparmor.d/{,**} r,

  # Harmless to allow
  /etc/dpkg/{,**} r,
  /etc/init.d/{,**} r,
  /etc/machine-id r,
  /etc/sensors.d/{,**} r,
  /etc/sensors3.conf r,
  /etc/vim/vimrc r,
  /var/lib/dbus/machine-id r,

  # Explicitly allow access to the main filesystem structure
  / r,
  /*/ r,
  /opt/{,**} r,
  /usr/{,**} r,

  # Explicitly allow access to dpkg database
  /var/lib/dpkg/{,**} r,

  # Explicitly allow access to journalctl logs
  /{run,var}/log/journal/{,**} r,

  owner /root/ r,
  owner /root/*/ rw,
  owner /root/*/** mrix,
  owner /root/*/** rwkl -> /root/*/**,
  owner /root/dont-delete-me-please.txt r,

  # See all processes, users, the kernel settings, the hardware, the network...
  @{sys}/{,**} r,
  @{PROC}/{,**} r,

  # A list of actions explicitly denied to the role in order to not fill the logs

  deny capability sys_ptrace,
  deny capability fsetid,

  deny network inet dgram,
  deny network inet6 dgram,
  deny network inet raw,
  deny network inet6 raw,

  deny ptrace read,

  deny @{bin}/{kmod,lsmod,depmod,insmod,rmmod,modinfo,modprobe} x,

        deny owner /root/.config/htop/htoprc w,
  audit deny owner /root/.config/ r,
  audit deny owner /root/.config/htop/ r,
  audit deny owner /root/.ssh/{,**} w,

  include if exists <local/role_root>
}

# vim:syntax=apparmor
