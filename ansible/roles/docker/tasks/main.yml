---

- name: Add Docker APT key
  ansible.builtin.get_url:
    url: 'https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg'
    dest: '/usr/share/keyrings/docker.asc'
    mode: '0644'

- name: Add Docker APT repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch=amd64 signed-by=/usr/share/keyrings/docker.asc]
      https://download.docker.com/linux/{{ ansible_distribution | lower }}
      {{ ansible_distribution_release }} stable
    state: present

- name: Install requested packages
  ansible.builtin.package:
    name: '{{ q("flattened", (docker__base_packages
                              + docker__packages)) }}'
    state: 'present'
    update_cache: true
    install_recommends: false

- name: Ensure we are logged into the internal Docker registry
  community.docker.docker_login:
    registry: '{{ docker__registry_url }}'
    username: '{{ docker__registry_user }}'
    password: '{{ docker__registry_token }}'
  when: docker__registry_enabled

- name: Install docker monitoring tools
  ansible.builtin.include_tasks: tools.yml
  when: docker__with_tools
