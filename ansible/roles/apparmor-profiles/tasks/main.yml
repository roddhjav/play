---

- name: Install requested packages
  ansible.builtin.package:
    name: '{{ (apparmor_profiles__base_packages + apparmor_profiles__packages) | flatten }}'
    state: 'present'
    install_recommends: false

- name: Enable journald audit
  ansible.builtin.service:
    name: systemd-journald-audit.socket
    enabled: true

- name: Ensure old apparmor cache directory is clean
  ansible.builtin.file:
    path: /var/cache/apparmor
    state: absent

- name: Configure apparmor for large set of profiles
  ansible.builtin.copy:
    src: parser.conf
    dest: /etc/apparmor/parser.conf
    mode: "0644"

- name: Ensure that Ansible will work with apparmor enabled
  ansible.builtin.copy:
    content: |
      owner @{HOME}/.ansible/tmp/ansible-tmp-*/* rw,
    dest: /etc/apparmor.d/local/sftp-server
    mode: "0644"

- name: Install local profiles
  ansible.builtin.include_tasks: local.yml
  when: apparmor_profiles__with_local
  tags: ['local']

- name: Install apparmor.d
  ansible.builtin.include_tasks: apparmord.yml
  when: apparmor_profiles__with_apparmord
  tags: ['apparmord']

- name: Configure AppArmor RBAC
  ansible.builtin.include_tasks: pam.yml
  when: apparmor_profiles__with_pam
  tags: ['pam']

- name: Restart apparmor
  ansible.builtin.service:
    name: apparmor
    state: restarted
    enabled: true

- name: Reboot if required
  ansible.builtin.include_tasks: reboot.yml

# NOTE: this is good, but not enough:
# In fully enforced mode: FSP with pam role (and no default profile), the reboot
# would prevent ansible to install the apparmor_local role with the pam roles.
# However, if we do it before the reboot, the pam role config would prevent this
# role install. Thus, the apparmor reload needs to be postponed.
# Solution; we need to ensure that;
# 1. the apparmor.d packages are installed
# 2. the apparmor_local profile are installed
# 3. Only then apparmor service is restarted
# 4. The pam config is set
# 5. Reboot the machine
